

-- Create Database
CREATE DATABASE IF NOT EXISTS pwskills_db;
USE pwskills_db;

-- Create Products table
CREATE TABLE Products (
    ProductID INT PRIMARY KEY AUTO_INCREMENT,
    ProductName VARCHAR(100),
    Category VARCHAR(50),
    Price DECIMAL(10,2),
    Quantity INT
);

-- Insert Sample Data
INSERT INTO Products (ProductName, Category, Price, Quantity) VALUES
('Laptop', 'Electronics', 60000, 1),
('Mouse', 'Electronics', 500, 10),
('Keyboard', 'Electronics', 800, 5),
('Chair', 'Furniture', 2500, 2),
('Table', 'Furniture', 4000, 1);

-- Q6: CTE to calculate total revenue per product (Revenue > 3000)
WITH RevenueCTE AS (
    SELECT ProductID, ProductName, Price * Quantity AS Revenue
    FROM Products
)
SELECT * FROM RevenueCTE
WHERE Revenue > 3000;

-- Q7: Create view vw_CategorySummary
CREATE OR REPLACE VIEW vw_CategorySummary AS
SELECT 
    Category,
    COUNT(*) AS TotalProducts,
    AVG(Price) AS AveragePrice
FROM Products
GROUP BY Category;

-- Q8: Create updatable view and update price
CREATE OR REPLACE VIEW vw_ProductPrice AS
SELECT ProductID, ProductName, Price
FROM Products;

UPDATE vw_ProductPrice
SET Price = 65000
WHERE ProductID = 1;

-- Q9: Stored Procedure to get products by category
DELIMITER $$
CREATE PROCEDURE GetProductsByCategory(IN cat_name VARCHAR(50))
BEGIN
    SELECT * FROM Products
    WHERE Category = cat_name;
END $$
DELIMITER ;

-- Q10: Archive table and trigger
CREATE TABLE ProductArchive (
    ProductID INT,
    ProductName VARCHAR(100),
    Category VARCHAR(50),
    Price DECIMAL(10,2),
    DeletedAt TIMESTAMP
);

DELIMITER $$
CREATE TRIGGER trg_after_delete_products
AFTER DELETE ON Products
FOR EACH ROW
BEGIN
    INSERT INTO ProductArchive
    VALUES (OLD.ProductID, OLD.ProductName, OLD.Category, OLD.Price, NOW());
END $$
DELIMITER ;

